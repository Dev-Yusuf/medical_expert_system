{% extends 'expert_system_app/base.html' %}

{% block title %}Chatbot - Medical Expert System{% endblock %}



{% block content %}
    <h2>Chat with our AI Medical Assistant</h2>
    <p>Describe the patient's symptoms, and the AI will provide preliminary guidance. For a full diagnosis, please use the <a href="{% url 'expert_system_app:diagnosis_form' %}">Diagnosis Form</a>.</p>

    <div id="chat-container">
        <div id="chatbox">
            <div class="chat-message bot-message">
                <div class="message-bubble">
                    Hello! I am an AI assistant. How can I help you today? Please describe the patient's symptoms.
                </div>
            </div>
            <!-- Chat messages will be appended here -->
        </div>
        <div class="typing-indicator">The assistant is typing...</div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type your message here..." autofocus>
            <button id="send-button">Send</button>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatbox = document.getElementById('chatbox');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const typingIndicator = document.querySelector('.typing-indicator');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function addMessageToChatbox(message, sender) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');

        const messageBubble = document.createElement('div');
        messageBubble.classList.add('message-bubble');
        messageBubble.textContent = message;
        
        messageContainer.appendChild(messageBubble);
        chatbox.appendChild(messageContainer);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (message === '') return;

        addMessageToChatbox(message, 'user');
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        typingIndicator.style.display = 'block';

        try {
            const response = await fetch("{% url 'expert_system_app:chatbot_query' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ message: message })
            });

            const data = await response.json();

            if (data.reply) {
                addMessageToChatbox(data.reply, 'bot');
            } else {
                addMessageToChatbox(data.error || "An unknown error occurred.", 'bot');
            }

        } catch (error) {
            console.error('Error sending message to chatbot:', error);
            addMessageToChatbox("Sorry, I couldn't connect to the server. Please check your connection and try again.", 'bot');
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            typingIndicator.style.display = 'none';
            chatInput.focus();
        }
    }

    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });
});
</script>
{% endblock %}